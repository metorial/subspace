model ProviderToolGlobal {
  oid BigInt @id
  id  String @unique

  key String

  providerOid BigInt
  provider    Provider @relation(fields: [providerOid], references: [oid])

  currentInstanceOid BigInt?
  currentInstance    ProviderTool? @relation(fields: [currentInstanceOid], references: [oid], name: "currentToolInstance")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  providerTools ProviderTool[]

  @@unique([providerOid, key])
}

model ProviderTool {
  oid BigInt @id
  id  String @unique

  specId               String
  specUniqueIdentifier String
  callableId           String
  key                  String

  name        String
  description String?

  /// [ProviderToolValue]
  value Json

  hash String

  providerOid BigInt
  provider    Provider @relation(fields: [providerOid], references: [oid])

  specificationOid BigInt
  specification    ProviderSpecification @relation(fields: [specificationOid], references: [oid])

  globalOid BigInt
  global    ProviderToolGlobal @relation(fields: [globalOid], references: [oid])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  currentInGlobal ProviderToolGlobal[] @relation("currentToolInstance")
  sessionMessages SessionMessage[]

  @@unique([providerOid, specificationOid, hash])
  @@unique([specificationOid, key])
}

model ProviderAuthMethodGlobal {
  oid BigInt @id
  id  String @unique

  key String

  providerOid BigInt
  provider    Provider @relation(fields: [providerOid], references: [oid])

  currentInstanceOid BigInt?
  currentInstance    ProviderAuthMethod? @relation(fields: [currentInstanceOid], references: [oid], name: "currentAuthMethodInstance")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  providerAuthMethods ProviderAuthMethod[]

  @@unique([providerOid, key])
}

enum ProviderAuthMethodType {
  oauth
  token
  service_account
  custom
}

model ProviderAuthMethod {
  oid BigInt @id
  id  String @unique

  specId               String
  specUniqueIdentifier String
  callableId           String
  key                  String

  type ProviderAuthMethodType

  isDefault Boolean

  name        String
  description String?

  /// [ProviderAuthMethodValue]
  value Json

  hash String

  providerOid BigInt
  provider    Provider @relation(fields: [providerOid], references: [oid])

  specificationOid BigInt
  specification    ProviderSpecification @relation(fields: [specificationOid], references: [oid])

  globalOid BigInt
  global    ProviderAuthMethodGlobal @relation(fields: [globalOid], references: [oid])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  providerOAuthSetups   ProviderOAuthSetup[]
  providerAuthConfigs   ProviderAuthConfig[]
  currentInGlobal       ProviderAuthMethodGlobal[] @relation("currentAuthMethodInstance")
  providerSetupSessions ProviderSetupSession[]

  @@unique([providerOid, specificationOid, hash])
  @@unique([specificationOid, key])
  @@index([isDefault])
}

model ProviderSpecification {
  oid BigInt @id
  id  String @unique

  specId               String
  specUniqueIdentifier String
  key                  String

  name        String
  description String?

  /// [ProviderSpecificationValue]
  value Json

  hash String

  supportsAuthMethod Boolean
  configContainsAuth Boolean

  providerOid BigInt
  provider    Provider @relation(fields: [providerOid], references: [oid])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  providerVersions                                     ProviderVersion[]
  providerTools                                        ProviderTool[]
  providerAuthMethods                                  ProviderAuthMethod[]
  providerDeployments                                  ProviderDeployment[]
  providerDeploymentConfigPairProviderVersions         ProviderDeploymentConfigPairProviderVersion[]
  providerDeploymentConfigPairSpecificationChangesFrom ProviderDeploymentConfigPairSpecificationChange[] @relation("SpecChangeFrom")
  providerDeploymentConfigPairSpecificationChangesTo   ProviderDeploymentConfigPairSpecificationChange[] @relation("SpecChangeTo")
  providerVersionSpecificationChangesFrom              ProviderVersionSpecificationChange[]              @relation("SpecChangeFrom")
  providerVersionSpecificationChangesTo                ProviderVersionSpecificationChange[]              @relation("SpecChangeTo")
  providerConfigs                                      ProviderConfig[]

  @@unique([providerOid, hash])
}
