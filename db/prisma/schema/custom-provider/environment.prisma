model CustomProviderEnvironment {
  oid BigInt @id
  id  String @unique

  tenantOid BigInt
  tenant    Tenant @relation(fields: [tenantOid], references: [oid])

  environmentOid BigInt
  environment    Environment @relation(fields: [environmentOid], references: [oid])

  providerEnvironmentOid BigInt?              @unique
  providerEnvironment    ProviderEnvironment? @relation(fields: [providerEnvironmentOid], references: [oid])

  customProviderOid BigInt
  customProvider    CustomProvider @relation(fields: [customProviderOid], references: [oid])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  customProviderEnvironmentVersions CustomProviderEnvironmentVersion[]
  customProviderDeployments         CustomProviderDeployment[]
  fromCustomProviderCommits         CustomProviderCommit[]             @relation("CustomProviderCommitFromEnvironment")
  toCustomProviderCommits           CustomProviderCommit[]             @relation("CustomProviderCommitToEnvironment")

  @@unique([environmentOid, customProviderOid])
}

model CustomProviderEnvironmentVersion {
  oid BigInt @id
  id  String @unique

  customProviderEnvironmentOid BigInt
  customProviderEnvironment    CustomProviderEnvironment @relation(fields: [customProviderEnvironmentOid], references: [oid])

  customProviderVersionOid BigInt
  customProviderVersion    CustomProviderVersion @relation(fields: [customProviderVersionOid], references: [oid])

  providerEnvironmentVersionOid BigInt?
  providerEnvironmentVersion    ProviderEnvironmentVersion? @relation(fields: [providerEnvironmentVersionOid], references: [oid])

  environmentOid BigInt
  environment    Environment @relation(fields: [environmentOid], references: [oid])

  commitOid BigInt
  commit    CustomProviderCommit @relation(fields: [commitOid], references: [oid])

  createdAt DateTime @default(now())

  @@unique([customProviderEnvironmentOid, customProviderVersionOid])
}

enum CustomProviderCommitStatus {
  pending
  applied
  failed
}

enum CustomProviderCommitTrigger {
  manual
  system
  // git
}

enum CustomProviderCommitType {
  create_version
  merge_version_into_environment
  rollback_environment_to_version
}

model CustomProviderCommit {
  oid BigInt @id
  id  String @unique

  status  CustomProviderCommitStatus
  trigger CustomProviderCommitTrigger
  type    CustomProviderCommitType

  message String?

  creatorActorOid BigInt
  creatorActor    Actor  @relation(fields: [creatorActorOid], references: [oid])

  fromEnvironmentOid BigInt?
  fromEnvironment    CustomProviderEnvironment? @relation(fields: [fromEnvironmentOid], references: [oid], name: "CustomProviderCommitFromEnvironment")

  toEnvironmentOid BigInt
  toEnvironment    CustomProviderEnvironment @relation(fields: [toEnvironmentOid], references: [oid], name: "CustomProviderCommitToEnvironment")

  toEnvironmentVersionBeforeOid BigInt?
  toEnvironmentVersionBefore    CustomProviderVersion? @relation(fields: [toEnvironmentVersionBeforeOid], references: [oid], name: "CustomProviderCommitToEnvVersionBefore")

  customProviderVersionOid BigInt
  customProviderVersion    CustomProviderVersion @relation(fields: [customProviderVersionOid], references: [oid])

  customProviderOid BigInt
  customProvider    CustomProvider @relation(fields: [customProviderOid], references: [oid])

  tenantOid BigInt
  tenant    Tenant @relation(fields: [tenantOid], references: [oid])

  solutionOid Int
  solution    Solution @relation(fields: [solutionOid], references: [oid])

  createdAt DateTime  @default(now())
  appliedAt DateTime?

  customProviderDeployments         CustomProviderDeployment[]
  customProviderEnvironmentVersions CustomProviderEnvironmentVersion[]
}
