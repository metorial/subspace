enum ProviderSetupSessionStatus {
  pending
  completed
  failed
  expired

  inactive
}

enum ProviderSetupSessionType {
  auth_only
  config_only
  auth_and_config
}

enum ProviderSetupSessionUiMode {
  metorial_elements // For consumer facing UIs
  dashboard_embeddable // For embedding in dashboards
}

model ProviderSetupSession {
  oid BigInt @id
  id  String @unique

  status          ProviderSetupSessionStatus
  type            ProviderSetupSessionType
  uiMode          ProviderSetupSessionUiMode @default(metorial_elements)
  isParentDeleted Boolean                    @default(false)

  clientSecret String

  name        String?
  description String?
  metadata    Json?

  redirectUrl String?

  tenantOid BigInt
  tenant    Tenant @relation(fields: [tenantOid], references: [oid])

  solutionOid BigInt
  solution    Solution @relation(fields: [solutionOid], references: [oid], onDelete: Cascade)

  providerOid BigInt
  provider    Provider @relation(fields: [providerOid], references: [oid])

  authMethodOid BigInt
  authMethod    ProviderAuthMethod @relation(fields: [authMethodOid], references: [oid])

  deploymentOid BigInt?
  deployment    ProviderDeployment? @relation(fields: [deploymentOid], references: [oid])

  authConfigOid BigInt?             @unique
  authConfig    ProviderAuthConfig? @relation(fields: [authConfigOid], references: [oid])

  configOid BigInt?         @unique
  config    ProviderConfig? @relation(fields: [configOid], references: [oid])

  oauthSetupOid BigInt?             @unique
  oauthSetup    ProviderOAuthSetup? @relation(fields: [oauthSetupOid], references: [oid])

  authCredentialsOid BigInt?
  authCredentials    ProviderAuthCredentials? @relation(fields: [authCredentialsOid], references: [oid])

  brandOid BigInt?
  brand    Brand?  @relation(fields: [brandOid], references: [oid], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  expiresAt DateTime

  events ProviderSetupSessionEvent[]

  @@index([status])
}

enum ProviderSetupSessionEventType {
  created
  link_opened
  config_set
  auth_config_set
  oauth_setup_completed
  oauth_setup_failed
  completed
  expired
}

model ProviderSetupSessionEvent {
  oid BigInt @id
  id  String @unique

  type ProviderSetupSessionEventType

  ip String?
  ua String?

  setupOid BigInt?
  setup    ProviderOAuthSetup? @relation(fields: [setupOid], references: [oid], onDelete: Cascade)

  sessionOid BigInt
  session    ProviderSetupSession @relation(fields: [sessionOid], references: [oid], onDelete: Cascade)

  createdAt DateTime @default(now())
}
