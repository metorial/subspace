enum SessionMessageStatus {
  waiting_for_response
  failed
  succeeded
}

enum SessionMessageType {
  tool_call
  mcp_control
  unknown
}

enum SessionMessageSource {
  client
}

enum SessionMessageFailureReason {
  timeout
  provider_error
  system_error
  none
}

model SessionMessage {
  oid        BigInt @id
  id         String @unique
  toolCallId String @unique

  status          SessionMessageStatus
  type            SessionMessageType
  source          SessionMessageSource
  failureReason   SessionMessageFailureReason @default(none)
  isParentDeleted Boolean                     @default(false)

  /// [SessionMessageClientMcpId]
  clientMcpId Json

  /// [SessionMessageInput]
  input Json?

  /// [SessionMessageOutput]
  output Json?

  methodOrToolKey String?
  isViaMcp        Boolean

  isProductive Boolean @default(true)

  isOffloadedToStorage Boolean                     @default(false)
  bucketOid            Int
  bucket               SessionMessageStorageBucket @relation(fields: [bucketOid], references: [oid])

  sessionOid BigInt
  session    Session @relation(fields: [sessionOid], references: [oid])

  senderParticipantOid BigInt
  senderParticipant    SessionParticipant @relation(fields: [senderParticipantOid], references: [oid], name: "SenderParticipant")

  responderParticipantOid BigInt?
  responderParticipant    SessionParticipant? @relation(fields: [responderParticipantOid], references: [oid], name: "ResponderParticipant")

  sessionProviderOid BigInt?
  sessionProvider    SessionProvider? @relation(fields: [sessionProviderOid], references: [oid])

  connectionOid BigInt?
  connection    SessionConnection? @relation(fields: [connectionOid], references: [oid])

  providerRunOid BigInt?
  providerRun    ProviderRun? @relation(fields: [providerRunOid], references: [oid])

  toolOid BigInt?
  tool    ProviderTool? @relation(fields: [toolOid], references: [oid])

  slateToolCallOid BigInt?
  slateToolCall    SlateToolCall? @relation(fields: [slateToolCallOid], references: [oid])

  errorOid BigInt?
  error    SessionError? @relation(fields: [errorOid], references: [oid])

  tenantOid BigInt
  tenant    Tenant @relation(fields: [tenantOid], references: [oid])

  solutionOid BigInt
  solution    Solution @relation(fields: [solutionOid], references: [oid])

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  sessionEvents SessionEvent[]

  @@index([isOffloadedToStorage])
}

model SessionMessageStorageBucket {
  oid       Int      @id
  bucket    String   @unique
  createdAt DateTime @default(now())

  sessionMessages SessionMessage[]
}
