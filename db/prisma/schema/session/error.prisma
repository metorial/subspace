enum SessionErrorType {
  message_processing_timeout
  message_processing_provider_error
  message_processing_system_error
}

model SessionErrorGroup {
  oid BigInt @id
  id  String @unique

  type SessionErrorType

  code    String
  message String

  hash String

  firstOccurrenceOid BigInt?
  firstOccurrence    SessionError? @relation(fields: [firstOccurrenceOid], references: [oid], name: "GroupToOccurrence")

  providerOid BigInt?
  provider    Provider? @relation(fields: [providerOid], references: [oid])

  tenantOid BigInt
  tenant    Tenant @relation(fields: [tenantOid], references: [oid])

  createdAt DateTime @default(now())

  occurrenceCount Int @default(0)

  instances                          SessionError[]
  sessionErrorGroupOccurrencePeriods SessionErrorGroupOccurrencePeriod[]

  @@unique([type, hash, tenantOid])
  @@index([type])
}

model SessionErrorGroupOccurrencePeriod {
  oid BigInt @id

  startsAt DateTime
  endsAt   DateTime

  occurrenceCount Int @default(0)

  groupOid BigInt
  group    SessionErrorGroup @relation(fields: [groupOid], references: [oid])

  @@unique([groupOid, startsAt])
}

model SessionError {
  oid BigInt @id
  id  String @unique

  type SessionErrorType

  isParentDeleted Boolean @default(false)
  isProcessing    Boolean

  code    String
  message String

  payload Json?

  groupOid BigInt?
  group    SessionErrorGroup? @relation(fields: [groupOid], references: [oid])

  connectionOid BigInt?
  connection    SessionConnection? @relation(fields: [connectionOid], references: [oid])

  sessionOid BigInt
  session    Session @relation(fields: [sessionOid], references: [oid])

  providerRunOid BigInt?
  providerRun    ProviderRun? @relation(fields: [providerRunOid], references: [oid])

  tenantOid BigInt
  tenant    Tenant @relation(fields: [tenantOid], references: [oid])

  solutionOid BigInt
  solution    Solution @relation(fields: [solutionOid], references: [oid])

  createdAt DateTime @default(now())

  instanceForGroup SessionErrorGroup[] @relation(name: "GroupToOccurrence")
  sessionMessages  SessionMessage[]
  sessionEvents    SessionEvent[]

  @@index([type])
}
